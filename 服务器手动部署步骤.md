# DCC数字员工系统 - 服务器手动部署步骤

## 问题分析
SSH连接失败的原因是：
1. SSH密钥认证失败
2. 服务器可能禁用了密码认证
3. 需要在服务器上手动执行部署步骤

## 解决方案

### 方法一：配置SSH密钥（推荐）

1. **在本地生成SSH密钥对**（如果还没有）：
```bash
ssh-keygen -t ed25519 -C "your-email@example.com"
```

2. **将公钥添加到服务器**：
```bash
# 复制公钥内容
cat ~/.ssh/id_ed25519.pub

# 然后SSH登录服务器，将公钥添加到authorized_keys
ssh root@47.103.27.235
mkdir -p ~/.ssh
echo "你的公钥内容" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

### 方法二：手动部署（当前推荐）

由于SSH连接问题，请按以下步骤在服务器上手动执行：

## 服务器部署步骤

### 1. 登录服务器
```bash
ssh root@47.103.27.235
# 输入密码登录
```

### 2. 进入项目目录
```bash
cd /opt/dcc-employee
```

### 3. 备份现有代码
```bash
tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz . --exclude=backup-*.tar.gz
```

### 4. 更新代码
您需要将本地代码上传到服务器。可以选择以下方式之一：

#### 方式A：使用scp上传（推荐）
在本地执行：
```bash
# 打包代码
tar -czf dcc-update.tar.gz \
    --exclude=node_modules \
    --exclude=venv \
    --exclude=.git \
    --exclude=__pycache__ \
    --exclude=*.pyc \
    --exclude=.env \
    --exclude=backup-*.tar.gz \
    .

# 上传到服务器
scp dcc-update.tar.gz root@47.103.27.235:/opt/dcc-employee/
```

然后在服务器上解压：
```bash
cd /opt/dcc-employee
tar -xzf dcc-update.tar.gz
rm dcc-update.tar.gz
chmod +x *.sh
```

#### 方式B：使用git更新
```bash
cd /opt/dcc-employee
git pull origin main
```

### 5. 配置环境变量
```bash
# 如果.env文件不存在，从模板创建
if [ ! -f .env ]; then
    cp env.template .env
    echo "请编辑 .env 文件，填入实际配置值"
    nano .env
fi
```

### 6. 停止现有服务
```bash
# 停止所有相关服务
docker-compose -f docker-compose-multi-project.yml down 2>/dev/null || true
docker-compose -f docker-compose.yml down 2>/dev/null || true

# 清理旧容器和镜像（可选）
docker system prune -f
```

### 7. 启动服务
```bash
# 使用多项目配置启动（避免端口冲突）
docker-compose -f docker-compose-multi-project.yml up -d --build
```

### 8. 检查服务状态
```bash
# 查看服务状态
docker-compose -f docker-compose-multi-project.yml ps

# 查看服务日志
docker-compose -f docker-compose-multi-project.yml logs -f
```

### 9. 验证部署
```bash
# 测试API
curl http://localhost:8080/api/health

# 检查端口监听
netstat -tulpn | grep :8080
```

## 域名配置

### 1. 确保域名解析
确保 `campus.kongbaijiyi.com` 解析到服务器IP `47.103.27.235`

### 2. 配置防火墙
```bash
# 开放必要端口
ufw allow 8080
ufw allow 80
ufw allow 443
ufw allow 22

# 检查防火墙状态
ufw status
```

### 3. 测试访问
部署完成后，可以通过以下地址访问：
- 校园系统：http://campus.kongbaijiyi.com:8080
- API文档：http://campus.kongbaijiyi.com:8080/docs
- 健康检查：http://campus.kongbaijiyi.com:8080/api/health

## 常用管理命令

```bash
# 查看服务状态
docker-compose -f docker-compose-multi-project.yml ps

# 查看服务日志
docker-compose -f docker-compose-multi-project.yml logs -f

# 重启服务
docker-compose -f docker-compose-multi-project.yml restart

# 停止服务
docker-compose -f docker-compose-multi-project.yml down

# 更新服务
docker-compose -f docker-compose-multi-project.yml up -d --build

# 查看资源使用
docker stats
```

## 故障排除

### 1. 端口冲突
```bash
# 检查端口占用
netstat -tulpn | grep :8080
netstat -tulpn | grep :3307

# 如果端口被占用，停止相关服务
sudo systemctl stop nginx  # 如果系统nginx在运行
```

### 2. 服务启动失败
```bash
# 查看详细日志
docker-compose -f docker-compose-multi-project.yml logs backend
docker-compose -f docker-compose-multi-project.yml logs frontend
docker-compose -f docker-compose-multi-project.yml logs mysql
```

### 3. 数据库连接问题
```bash
# 检查MySQL容器
docker exec -it dcc-mysql mysql -u root -p

# 检查数据库
docker exec -it dcc-mysql mysql -u root -p -e "SHOW DATABASES;"
```

## 完成后的访问地址

部署成功后，您可以通过以下地址访问系统：

- **校园系统主页**：http://campus.kongbaijiyi.com:8080
- **API接口**：http://campus.kongbaijiyi.com:8080/api
- **API文档**：http://campus.kongbaijiyi.com:8080/docs
- **健康检查**：http://campus.kongbaijiyi.com:8080/api/health

## 注意事项

1. 确保域名 `campus.kongbaijiyi.com` 已正确解析到服务器IP
2. 确保服务器防火墙开放了8080端口
3. 如果使用HTTPS，需要配置SSL证书
4. 定期备份数据库和配置文件
