# leads_task_list è¡¨æ›´æ–°æµç¨‹åˆ†æ

## æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æäº†åˆ›å»ºè‡ªåŠ¨å¤–å‘¼ä»»åŠ¡åï¼Œ`leads_task_list` è¡¨ä¸­å„å­—æ®µçš„æ›´æ–°é¡ºåºå’Œé¢‘ç‡ï¼Œæ—¨åœ¨æ‰¾å‡ºæ€§èƒ½ä¼˜åŒ–ç‚¹ã€‚

## è¡¨ç»“æ„å­—æ®µ

æ ¹æ®ä»£ç åˆ†æï¼Œ`leads_task_list` è¡¨åŒ…å«ä»¥ä¸‹å…³é”®å­—æ®µï¼š
- `task_id` - ä»»åŠ¡ID
- `leads_id` - çº¿ç´¢ID
- `leads_name` - çº¿ç´¢åç§°
- `leads_phone` - çº¿ç´¢ç”µè¯
- `call_time` - å‘¼å«æ—¶é—´
- `call_job_id` - å‘¼å«ä»»åŠ¡IDï¼ˆé˜¿é‡Œäº‘ï¼‰
- `call_status` - å‘¼å«çŠ¶æ€ï¼ˆSucceeded/Failedç­‰ï¼‰
- `planed_time` - è®¡åˆ’æ—¶é—´
- `call_task_id` - å‘¼å«ä»»åŠ¡IDï¼ˆé˜¿é‡Œäº‘å†…éƒ¨ï¼‰
- `call_conversation` - é€šè¯ä¼šè¯ï¼ˆJSONï¼‰
- `calling_number` - ä¸»å«å·ç 
- `recording_url` - å½•éŸ³URL
- `leads_follow_id` - è·Ÿè¿›è®°å½•ID
- `is_interested` - æ˜¯å¦æ„Ÿå…´è¶£ï¼ˆ0/1/2ï¼‰

---

## æ›´æ–°æµç¨‹æ—¶åºå›¾

### é˜¶æ®µ1ï¼šåˆ›å»ºä»»åŠ¡ï¼ˆcreate-autoCall-tasksï¼‰

**ä½ç½®**: `auto_call_api.py:246-260`

```sql
INSERT INTO leads_task_list 
(task_id, leads_id, leads_name, leads_phone, call_time, call_job_id)
VALUES (%s, %s, %s, %s, %s, %s)
```

**æ›´æ–°å­—æ®µ**:
- âœ… `task_id`
- âœ… `leads_id`
- âœ… `leads_name`
- âœ… `leads_phone`
- âœ… `call_time`
- âœ… `call_job_id` (åˆå§‹ä¸ºç©ºå­—ç¬¦ä¸²)

**æ‰§è¡Œæ–¹å¼**: å¾ªç¯é€ä¸ªæ’å…¥ï¼ˆ`for lead in leads_result`ï¼‰

**æ€§èƒ½é—®é¢˜**: 
- âš ï¸ **é€ä¸ªINSERTï¼Œæ²¡æœ‰ä½¿ç”¨æ‰¹é‡æ’å…¥**

---

### é˜¶æ®µ2ï¼šå¼€å§‹å¤–å‘¼ä»»åŠ¡ï¼ˆstart-call-taskï¼‰

**ä½ç½®**: `auto_call_api.py:1171-1175`

```sql
UPDATE leads_task_list 
SET call_job_id = %s 
WHERE id = %s
```

**æ›´æ–°å­—æ®µ**:
- âœ… `call_job_id` (ä»é˜¿é‡Œäº‘è·å–)

**æ‰§è¡Œæ–¹å¼**: å¾ªç¯é€ä¸ªæ›´æ–°ï¼ˆ`for i, lead_record in enumerate(leads_records)`ï¼‰

**æ€§èƒ½é—®é¢˜**: 
- âš ï¸ **é€ä¸ªUPDATEï¼Œå¯ä»¥æ”¹ä¸ºæ‰¹é‡æ›´æ–°**

---

### é˜¶æ®µ3ï¼šæŸ¥è¯¢ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼ˆquery-task-executionï¼‰

**ä½ç½®**: `auto_call_api.py:1648-1670` å’Œ `auto_task_monitor.py:226-250`

```sql
UPDATE leads_task_list 
SET call_status = %s,
    planed_time = %s,
    call_task_id = %s,
    call_conversation = %s,
    calling_number = %s,
    recording_url = %s
WHERE task_id = %s AND call_job_id = %s
```

**æ›´æ–°å­—æ®µ**:
- âœ… `call_status`
- âœ… `planed_time`
- âœ… `call_task_id`
- âœ… `call_conversation`
- âœ… `calling_number`
- âœ… `recording_url`

**æ‰§è¡Œæ–¹å¼**: 
- å¾ªç¯é€ä¸ªæ›´æ–°ï¼ˆ`for job_data in jobs_data`ï¼‰
- æœ‰å˜åŒ–æ£€æµ‹æœºåˆ¶ï¼ˆ`has_changes`ï¼‰ï¼Œæ— å˜åŒ–æ—¶è·³è¿‡æ›´æ–°

**è°ƒç”¨é¢‘ç‡**:
- æ‰‹åŠ¨æŸ¥è¯¢ï¼šç”¨æˆ·ä¸»åŠ¨è°ƒç”¨ `/query-task-execution`
- è‡ªåŠ¨ç›‘æ§ï¼šå®šæ—¶ä»»åŠ¡æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆ`auto_task_monitor.py`ï¼‰

**æ€§èƒ½é—®é¢˜**: 
- âš ï¸ **é€ä¸ªUPDATEï¼Œè™½ç„¶æœ‰å˜åŒ–æ£€æµ‹ï¼Œä½†ä»éœ€å¾ªç¯åˆ¤æ–­**
- âš ï¸ **å½•éŸ³URLè·å–æ˜¯åŒæ­¥çš„ï¼Œå¯èƒ½è¾ƒè€—æ—¶**

---

### é˜¶æ®µ4ï¼šåˆ›å»º/æ›´æ–°è·Ÿè¿›è®°å½•

#### 4.1 é¦–æ¬¡åˆ›å»ºè·Ÿè¿›è®°å½•

**ä½ç½®**: `auto_call_api.py:2301-2305` å’Œ `auto_task_monitor.py:460-465`

```sql
UPDATE leads_task_list 
SET leads_follow_id = %s, is_interested = %s
WHERE call_job_id = %s
```

**æ›´æ–°å­—æ®µ**:
- âœ… `leads_follow_id`
- âœ… `is_interested`

**æ‰§è¡Œæ–¹å¼**: å•ä¸ªæ›´æ–°ï¼ˆé€šè¿‡ `call_job_id` åŒ¹é…ï¼‰

**è§¦å‘æ—¶æœº**:
- å¼‚æ­¥çº¿ç¨‹ï¼šå½“ `call_status` ä¸º `Succeeded`/`Failed` ä¸”æœ‰ä¼šè¯æ—¶
- å®šæ—¶ç›‘æ§ï¼šè‡ªåŠ¨æ£€æŸ¥å¹¶åˆ›å»ºè·Ÿè¿›è®°å½•

#### 4.2 æ›´æ–°è·Ÿè¿›è®°å½•ï¼ˆforce-analyzeï¼‰

**ä½ç½®**: `auto_call_api.py:2263-2267`

```sql
UPDATE leads_task_list
SET is_interested = %s
WHERE call_job_id = %s
```

**æ›´æ–°å­—æ®µ**:
- âœ… `is_interested` (ä»…æ›´æ–°æ„å‘)

**æ‰§è¡Œæ–¹å¼**: å•ä¸ªæ›´æ–°

---

## æ›´æ–°é¢‘ç‡ç»Ÿè®¡

| å­—æ®µå | æ›´æ–°æ¬¡æ•° | æ›´æ–°é˜¶æ®µ | æ˜¯å¦æ‰¹é‡ |
|--------|---------|---------|---------|
| `task_id` | 1 | åˆ›å»ºæ—¶ | âŒ é€ä¸ª |
| `leads_id` | 1 | åˆ›å»ºæ—¶ | âŒ é€ä¸ª |
| `leads_name` | 1 | åˆ›å»ºæ—¶ | âŒ é€ä¸ª |
| `leads_phone` | 1 | åˆ›å»ºæ—¶ | âŒ é€ä¸ª |
| `call_time` | 1 | åˆ›å»ºæ—¶ | âŒ é€ä¸ª |
| `call_job_id` | 2 | åˆ›å»ºæ—¶(ç©º) + å¼€å§‹å¤–å‘¼æ—¶ | âŒ é€ä¸ª |
| `call_status` | å¤šæ¬¡ | æŸ¥è¯¢æ‰§è¡Œæ—¶ | âŒ é€ä¸ª |
| `planed_time` | å¤šæ¬¡ | æŸ¥è¯¢æ‰§è¡Œæ—¶ | âŒ é€ä¸ª |
| `call_task_id` | å¤šæ¬¡ | æŸ¥è¯¢æ‰§è¡Œæ—¶ | âŒ é€ä¸ª |
| `call_conversation` | å¤šæ¬¡ | æŸ¥è¯¢æ‰§è¡Œæ—¶ | âŒ é€ä¸ª |
| `calling_number` | å¤šæ¬¡ | æŸ¥è¯¢æ‰§è¡Œæ—¶ | âŒ é€ä¸ª |
| `recording_url` | å¤šæ¬¡ | æŸ¥è¯¢æ‰§è¡Œæ—¶ | âŒ é€ä¸ª |
| `leads_follow_id` | 1 | åˆ›å»ºè·Ÿè¿›æ—¶ | âœ… å•ä¸ª |
| `is_interested` | 1-2 | åˆ›å»º/æ›´æ–°è·Ÿè¿›æ—¶ | âœ… å•ä¸ª |

---

## æ€§èƒ½é—®é¢˜åˆ†æ

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### 1. æ‰¹é‡æ’å…¥æ”¹ä¸ºé€æ¡æ’å…¥
**ä½ç½®**: `auto_call_api.py:251-260`

**é—®é¢˜**: åˆ›å»ºä»»åŠ¡æ—¶ï¼Œå¯¹æ¯ä¸ªçº¿ç´¢éƒ½æ‰§è¡Œä¸€æ¬¡ `INSERT` æ“ä½œ

**å½±å“**: å¦‚æœæœ‰1000ä¸ªçº¿ç´¢ï¼Œå°±éœ€è¦æ‰§è¡Œ1000æ¬¡æ•°æ®åº“æ“ä½œ

**ä¼˜åŒ–å»ºè®®**:
```python
# å½“å‰ä»£ç ï¼ˆé€ä¸ªæ’å…¥ï¼‰
for lead in leads_result:
    execute_update(list_query, list_params)

# ä¼˜åŒ–åï¼ˆæ‰¹é‡æ’å…¥ï¼‰
all_params = [
    (task_id, lead['leads_id'], lead['leads_user_name'], 
     lead['leads_user_phone'], current_time, "")
    for lead in leads_result
]
batch_insert_query = """
    INSERT INTO leads_task_list 
    (task_id, leads_id, leads_name, leads_phone, call_time, call_job_id)
    VALUES %s
"""
# ä½¿ç”¨ executemany æˆ–æ‰¹é‡æ’å…¥è¯­æ³•
```

#### 2. call_job_id æ›´æ–°æ”¹ä¸ºæ‰¹é‡æ›´æ–°
**ä½ç½®**: `auto_call_api.py:1167-1175`

**é—®é¢˜**: å¼€å§‹å¤–å‘¼ä»»åŠ¡æ—¶ï¼Œé€ä¸ªæ›´æ–° `call_job_id`

**å½±å“**: å¦‚æœæœ‰1000ä¸ªçº¿ç´¢ï¼Œå°±éœ€è¦æ‰§è¡Œ1000æ¬¡ `UPDATE` æ“ä½œ

**ä¼˜åŒ–å»ºè®®**:
```python
# å½“å‰ä»£ç ï¼ˆé€ä¸ªæ›´æ–°ï¼‰
for i, lead_record in enumerate(leads_records):
    if i < len(jobs_id):
        execute_update(update_leads_query, (job_id, lead_record['id']))

# ä¼˜åŒ–åï¼ˆæ‰¹é‡æ›´æ–°ï¼‰
# æ–¹æ¡ˆ1ï¼šä½¿ç”¨ CASE WHEN æ‰¹é‡æ›´æ–°
update_query = """
    UPDATE leads_task_list 
    SET call_job_id = CASE id
"""
params = []
for i, lead_record in enumerate(leads_records):
    if i < len(jobs_id):
        update_query += f" WHEN %s THEN %s"
        params.extend([lead_record['id'], str(jobs_id[i])])
update_query += " END WHERE task_id = %s"
params.append(request.task_id)

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨ä¸´æ—¶è¡¨æ‰¹é‡æ›´æ–°
# æˆ–ä½¿ç”¨ executemany
```

#### 3. æŸ¥è¯¢æ‰§è¡Œæƒ…å†µæ—¶é€ä¸ªæ›´æ–°
**ä½ç½®**: `auto_call_api.py:1648-1670`

**é—®é¢˜**: è™½ç„¶è°ƒç”¨äº†æ‰¹é‡æŸ¥è¯¢æ¥å£ï¼ˆ`ListJobsSample.main`ï¼‰ï¼Œä½†æ›´æ–°æ•°æ®åº“æ—¶ä»æ˜¯é€ä¸ªæ›´æ–°

**å½±å“**: æ¯é¡µ20æ¡è®°å½•ï¼Œå°±éœ€è¦æ‰§è¡Œ20æ¬¡ `UPDATE` æ“ä½œ

**ä¼˜åŒ–å»ºè®®**:
```python
# å½“å‰ä»£ç ï¼ˆé€ä¸ªæ›´æ–°ï¼‰
for job_data in jobs_data:
    if has_changes:
        execute_update(update_query, update_params)

# ä¼˜åŒ–åï¼ˆæ‰¹é‡æ›´æ–°ï¼‰
# æ”¶é›†æ‰€æœ‰éœ€è¦æ›´æ–°çš„è®°å½•
updates = []
for job_data in jobs_data:
    if has_changes:
        updates.append((job_status, plan_time, call_task_id, ...))

# ä½¿ç”¨æ‰¹é‡æ›´æ–°
if updates:
    batch_update_query = """
        UPDATE leads_task_list 
        SET call_status = data.call_status,
            planed_time = data.planed_time,
            ...
        FROM (VALUES %s) AS data(...)
        WHERE leads_task_list.call_job_id = data.call_job_id
    """
    # æ‰§è¡Œæ‰¹é‡æ›´æ–°
```

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

#### 4. å½•éŸ³URLè·å–å¯èƒ½é˜»å¡
**ä½ç½®**: `auto_call_api.py:1601-1609`

**é—®é¢˜**: è·å–å½•éŸ³URLæ˜¯åŒæ­¥æ“ä½œï¼Œå¯èƒ½è¾ƒè€—æ—¶

**å½±å“**: å¦‚æœè·³è¿‡å½•éŸ³è·å–ï¼ˆ`skip_recording=True`ï¼‰ï¼Œå¯ä»¥æå‡æ€§èƒ½

**ç°çŠ¶**: å·²æœ‰ `skip_recording` å‚æ•°ï¼Œé»˜è®¤ `True`ï¼Œè¿™æ˜¯åˆç†çš„

#### 5. å˜åŒ–æ£€æµ‹ä»æœ‰ä¼˜åŒ–ç©ºé—´
**ä½ç½®**: `auto_call_api.py:1615-1644`

**é—®é¢˜**: è™½ç„¶å·²æœ‰å˜åŒ–æ£€æµ‹ï¼Œä½†ä»éœ€è¦é€ä¸ªæ¯”è¾ƒ

**ä¼˜åŒ–å»ºè®®**: 
- å¯ä»¥è€ƒè™‘åœ¨åº”ç”¨å±‚ç¼“å­˜æ›´å¤šæ•°æ®ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
- æˆ–è€…ä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨åœ¨å­—æ®µå˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°

### ğŸŸ¢ å·²ä¼˜åŒ–çš„ç‚¹

1. âœ… **æ‰¹é‡æŸ¥è¯¢å½“å‰çŠ¶æ€**: `auto_call_api.py:1515-1542` å·²ç»å®ç°äº†æ‰¹é‡æŸ¥è¯¢ï¼Œé¿å…N+1æŸ¥è¯¢é—®é¢˜
2. âœ… **æ‰¹é‡æŸ¥è¯¢è·Ÿè¿›æ•°æ®**: `auto_call_api.py:1530-1542` å·²ç»å®ç°äº†æ‰¹é‡æŸ¥è¯¢è·Ÿè¿›æ•°æ®
3. âœ… **å˜åŒ–æ£€æµ‹æœºåˆ¶**: `auto_call_api.py:1615-1644` å·²ç»å®ç°äº†å˜åŒ–æ£€æµ‹ï¼Œæ— å˜åŒ–æ—¶è·³è¿‡æ›´æ–°
4. âœ… **å¼‚æ­¥å¤„ç†AIåˆ†æ**: `auto_call_api.py:1694-1696` ä½¿ç”¨çº¿ç¨‹å¼‚æ­¥å¤„ç†AIåˆ†æï¼Œä¸é˜»å¡ä¸»æµç¨‹

---

## ä¼˜åŒ–å»ºè®®æ€»ç»“

### ä¼˜å…ˆçº§1ï¼šç«‹å³ä¼˜åŒ–ï¼ˆé«˜å½±å“ï¼‰

1. **æ‰¹é‡æ’å…¥åˆå§‹è®°å½•** - åˆ›å»ºä»»åŠ¡æ—¶ä½¿ç”¨æ‰¹é‡æ’å…¥
2. **æ‰¹é‡æ›´æ–° call_job_id** - å¼€å§‹å¤–å‘¼æ—¶ä½¿ç”¨æ‰¹é‡æ›´æ–°

**é¢„æœŸæ•ˆæœ**: 
- 1000ä¸ªçº¿ç´¢çš„ä»»åŠ¡ï¼Œä»2000æ¬¡æ•°æ®åº“æ“ä½œå‡å°‘åˆ°2æ¬¡
- æ€§èƒ½æå‡çº¦ **100-1000å€**ï¼ˆå–å†³äºæ•°æ®åº“æ€§èƒ½ï¼‰

### ä¼˜å…ˆçº§2ï¼šä¸­æœŸä¼˜åŒ–ï¼ˆä¸­ç­‰å½±å“ï¼‰

3. **æ‰¹é‡æ›´æ–°æ‰§è¡ŒçŠ¶æ€** - æŸ¥è¯¢æ‰§è¡Œæƒ…å†µæ—¶ä½¿ç”¨æ‰¹é‡æ›´æ–°

**é¢„æœŸæ•ˆæœ**: 
- æ¯é¡µ20æ¡è®°å½•ï¼Œä»20æ¬¡æ›´æ–°å‡å°‘åˆ°1æ¬¡
- æ€§èƒ½æå‡çº¦ **10-20å€**

### ä¼˜å…ˆçº§3ï¼šé•¿æœŸä¼˜åŒ–ï¼ˆä½å½±å“ï¼‰

4. **æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–** - ç¡®ä¿æ•°æ®åº“è¿æ¥æ± é…ç½®åˆç†
5. **ç´¢å¼•ä¼˜åŒ–** - ç¡®ä¿ `call_job_id`, `task_id` ç­‰å­—æ®µæœ‰ç´¢å¼•
6. **è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—** - å¯¹äºå¤§é‡æ•°æ®çš„æ›´æ–°ï¼Œå¯ä»¥è€ƒè™‘å¼‚æ­¥å¤„ç†

---

## æ•°æ®åº“ç´¢å¼•å»ºè®®

ç¡®ä¿ä»¥ä¸‹å­—æ®µæœ‰ç´¢å¼•ï¼š
- `task_id` - ä¸»é”®æˆ–ç´¢å¼•
- `call_job_id` - å”¯ä¸€ç´¢å¼•ï¼ˆå¦‚æœå¯èƒ½ï¼‰
- `leads_id` - ç´¢å¼•ï¼ˆå¦‚æœç»å¸¸æŸ¥è¯¢ï¼‰
- `leads_follow_id` - ç´¢å¼•

---

## æµ‹è¯•å»ºè®®

ä¼˜åŒ–åï¼Œå»ºè®®è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š
1. **å‹åŠ›æµ‹è¯•**: åˆ›å»º1000ä¸ªçº¿ç´¢çš„ä»»åŠ¡ï¼Œæµ‹è¯•æ‰¹é‡æ’å…¥æ€§èƒ½
2. **å¹¶å‘æµ‹è¯•**: å¤šä¸ªä»»åŠ¡åŒæ—¶å¼€å§‹å¤–å‘¼ï¼Œæµ‹è¯•æ‰¹é‡æ›´æ–°æ€§èƒ½
3. **ç›‘æ§æµ‹è¯•**: å®šæ—¶ä»»åŠ¡æŸ¥è¯¢æ‰§è¡Œæƒ…å†µï¼Œæµ‹è¯•æ‰¹é‡æ›´æ–°æ€§èƒ½

---

## é™„å½•ï¼šä»£ç ä½ç½®ç´¢å¼•

### auto_call_api.py

- **åˆ›å»ºä»»åŠ¡æ’å…¥**: `246-260`
- **å¼€å§‹å¤–å‘¼æ›´æ–°call_job_id**: `1171-1175`
- **æŸ¥è¯¢æ‰§è¡Œæƒ…å†µæ›´æ–°çŠ¶æ€**: `1648-1670`
- **åˆ›å»ºè·Ÿè¿›è®°å½•**: `2301-2305`
- **æ›´æ–°è·Ÿè¿›è®°å½•**: `2263-2267`
- **åå°æ‰§è¡Œæ›´æ–°**: `2005-2024`

### auto_task_monitor.py

- **å®šæ—¶ç›‘æ§æ›´æ–°çŠ¶æ€**: `226-250`
- **åˆ›å»ºè·Ÿè¿›è®°å½•**: `460-465`

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2024-12-19*
*åˆ†æèŒƒå›´: auto_call_api.py, auto_task_monitor.py*

