### 外呼任务全流程与页面接口梳理（后端/前端）

以下基于当前代码仓库实际实现梳理，涵盖：创建外呼任务后端处理流程、前端触发链路与轮询、以及各页面/组件对应的接口调用清单。

---

## 一、总体服务结构

- 后端入口：`backend/main.py`
  - 关键路由挂载（均带前缀 `/api`）：
    - 健康检查：`health_router`
    - 登录/认证：`login_router`、`auth_verify_router`
    - 组织：`organization_router`
    - 线索：`dcc_leads_router`
    - 外呼任务：`auto_call_router`
    - 配置检测：`config_check_router`
  - 启动事件：启动自动任务监控协程 `auto_task_monitor.start_monitoring()`

- 前端 API 封装：`dcc-digital-employee/src/services/api.ts`
  - 统一 `fetch` 封装 `apiRequest()`，在请求头附加 `access-token`
  - Token 校验：`/api/auth/verify`
  - 任务相关 API 暴露为 `tasksAPI`

---

## 二、创建外呼任务后端处理流程

触发端点：`POST /api/create-autoCall-tasks`
- 代码位置：`backend/api/auto_call_api.py` → `create_auto_call_task`
- 请求头：`access-token`
- 核心步骤（简化要点）：
  1. 通过 `verify_access_token` 解析 `user_id`，查询用户的 `dcc_user_org_id`
  2. 按筛选条件拼接 SQL，从 `dcc_leads` 选出去重后的线索，生成任务与 `leads_task_list`
  3. 返回任务基本信息（`task_id`、线索统计、筛选摘要 `size_desc` 等）

任务相关核心端点（同文件）：
- 分页获取任务列表：`GET /api/task_list` → `get_task_list`
- 获取任务汇总：`GET /api/task-stats` → `get_task_stats`
- 更新脚本 ID：`POST /api/update-script-id`
- 开始外呼：`POST /api/start-call-task` → `start_call_task`
  - 内部会：
    - 调用开放平台 `create_job_group` 获取 `job_group_id`
    - 更新 `call_tasks` 与 `leads_task_list`
    - 调用 `assign_jobs` 推送外呼
    - 记录/更新执行状态
- 分批执行运行（可后台进程）：
  - 创建运行：`POST /api/start-query-execution-run`
  - 查询运行：`GET /api/get-query-execution-run`
- 任务执行查询：`POST /api/query-task-execution`
- 跟进/统计/暂停恢复：`/api/get-leads-follow`、`/api/task-statistics`、`/api/suspend-resume-task`
- 自动化监控：`POST /api/auto-task`（start/stop/check）
  - 监控实现：`backend/api/auto_task_monitor.py`，并在 `main.py` 启动时自动拉起

认证相关：
- 登录：`POST /api/login`
- Token 验证：`GET /api/auth/verify`

---

## 三、创建外呼任务的前端触发与交互链路

前端关键组件：
- 任务创建抽屉：`src/components/TaskCreationDrawer.tsx`
  - 点击“创建任务”时调用：`tasksAPI.createCallTask()`
  - 构造数据：`{ task_name, script_id: '', size_desc }`
  - 任务进度 UI 为本地模拟（创建阶段），创建成功后通过回调 `onTaskCreated` 将任务加入列表

- 任务列表抽屉：`src/components/TaskListDrawer.tsx`
  - 维护本地任务列表，打开创建抽屉，接收 `onTaskCreated` 新增任务
  - 列表数据来源：`tasksAPI.getTaskListPaged()`（后端 `GET /api/task_list?page=1&page_size=20`）

- 任务详情抽屉：`src/components/TaskDetailDrawer.tsx`
  - 开始外呼：`tasksAPI.startCallTask(taskId)`（后端 `/api/start-call-task`）
  - 成功后关闭并通过 `onOutboundCallSuccess` 通知刷新

- 任务选择弹窗：`src/components/TaskSelectionModal.tsx`
  - 加载任务：`tasksAPI.getTaskListPaged()`，并前端筛选 `task_type ∈ {2,3,4,5}`

- 后台运行/进度：
  - 若使用后台运行：`tasksAPI.startQueryExecutionRun()` → `/api/start-query-execution-run`
  - 进度查询：`/api/get-query-execution-run`（组件如 `RunProgress.tsx` 可对接）

统一请求封装：`src/services/api.ts`
- 基地址：`API_BASE_URL`（`src/config/environment.ts`）
- 自动携带 `access-token`
- 401 统一跳转登录并清缓存

---

## 四、创建任务后的“端到端”顺序时序

1) 前端：`TaskCreationDrawer` → `tasksAPI.createCallTask()` → `POST /api/create-autoCall-tasks`
2) 后端：创建数据库任务与线索映射，返回 `task_id`、`size_desc` 等
3) 前端：
   - 更新 UI 列表（`TaskListDrawer`）
   - 可能展示统计：`GET /api/task-stats`（`tasksAPI.getCallTasksStatistics`）
4) 前端：在 `TaskDetailDrawer` 中选择脚本后 → 点击“开始外呼”
5) 前端：`tasksAPI.startCallTask(taskId)` → `POST /api/start-call-task`
6) 后端：
   - 校验任务状态/脚本/线索
   - 创建外呼 `job_group`，写入 `call_tasks`、`leads_task_list`
   - `assign_jobs` 推送外呼执行
7) 运行期：
   - 可选使用：`POST /api/start-query-execution-run` + `GET /api/get-query-execution-run` 轮询运行进度
   - 自动监控：`POST /api/auto-task`（或启动时自动运行）

---

## 五、页面/组件 — 接口映射清单

### 1) 页面层
- `/login`（`src/app/login/page.tsx`）
  - `POST /api/login`（通过 `AuthContext.login`）

- `/` 首页（`src/app/page.tsx`）
  - 依赖上下文登录状态；具体接口调用由各抽屉/组件触发（见组件层）

- `/test-env`（`src/app/test-env/page.tsx`）
  - `GET /api/health`
  - `POST /api/login`（测试用途）

### 2) 组件层（与外呼相关）
- `TaskCreationDrawer.tsx`
  - `POST /api/create-autoCall-tasks`（创建外呼任务）

- `TaskListDrawer.tsx`
  - `GET /api/tasks`（任务列表）

- `TaskDetailDrawer.tsx`
  - `POST /api/start-call-task`（开始外呼）

- `TaskSelectionModal.tsx`
  - `GET /api/tasks`（筛选已执行/完成/暂停任务）

- `RunProgress.tsx`（如对接后台运行）
  - `POST /api/start-query-execution-run`
  - `GET /api/get-query-execution-run`

- `DccBindModal.tsx`
  - `GET /api/auth/verify`（校验 token）

### 3) 任务列表分页接口（新）

- 路径：`GET /api/task_list`
- 查询参数：
  - `page`：页码（默认 1）
  - `page_size`：每页数量（默认 20）
- 返回示例（支持滚动加载）：

```
{
  "status": "success",
  "code": 200,
  "message": "获取任务列表成功",
  "data": {
    "items": [
      {
        "id": 123,
        "task_name": "任务A",
        "task_type": 2,
        "create_time": "2025-11-05 12:00:00",
        "leads_count": 300
      }
    ],
    "pagination": {
      "page": 1,
      "page_size": 20,
      "total": 1,
      "total_pages": 1
    }
  }
}
```

- 前端滚动加载建议：从 `page=1` 开始请求，累加 `items`，当 `page >= total_pages` 时停止。

### 4) 其他（线索/场景相关常用接口）
- 线索统计：`GET /api/leads/statistics`
- 场景创建：`POST /api/create_scene`
- 场景列表：`GET /api/scenes`

---

## 六、可能的问题与排查建议（基于现有实现）

- 脚本 ID 依赖：`/api/start-call-task` 要求任务必须已配置 `script_id`，否则直接报错。前端需确保在详情中先设置脚本，再允许“开始外呼”。
- 任务状态机：`start-call-task` 仅允许 `task_type == 1`（已创建）。若前端重复触发或状态未刷新，可能失败；前端应在调用前刷新任务状态。
- 运行监控：如果需要后台“长运行+进度”，请统一走 `start-query-execution-run`/`get-query-execution-run`，避免前端误以为 `start-call-task` 会持续返回进度。
- Token 校验：前端对 401 有统一跳转；但离线/网络错误场景会二次校验 token 并可能也跳转，注意用户体验。

---

## 七、接口速查表（与外呼最相关）

- 创建任务：`POST /api/create-autoCall-tasks`
- 分页获取任务列表：`GET /api/task_list`
- 获取任务汇总：`GET /api/task-stats`
- 更新脚本：`POST /api/update-script-id`
- 开始外呼：`POST /api/start-call-task`
- 后台运行（可选）：`POST /api/start-query-execution-run`、`GET /api/get-query-execution-run`
- 自动监控控制：`POST /api/auto-task`（`start`/`stop`/`check`）
- Token 验证：`GET /api/auth/verify`
- 登录：`POST /api/login`

---

如需我进一步绘制时序图或补充字段级别的请求/响应示例，请告诉我页面或接口优先级，我会按需扩充文档。


