# DCC数字员工系统 - 阿里云部署指南

## 端口冲突解决方案

### 问题描述
在阿里云服务器上部署多个项目时，如果其他项目也使用MySQL的3306端口，会产生端口冲突。

### 解决方案

#### 1. 当前配置的优势
我们的Docker配置已经很好地解决了这个问题：

- **MySQL端口隔离**：MySQL容器不暴露3306端口到主机
- **内部网络通信**：所有服务在Docker内部网络中通信
- **服务发现**：通过服务名而非IP地址访问

#### 2. 多项目部署策略

##### 方案A：完全隔离（推荐）
```bash
# 每个项目使用独立的Docker网络
docker network create dcc-network
docker network create other-project-network
```

##### 方案B：共享外部MySQL
如果服务器上已有MySQL服务，可以修改配置使用外部MySQL：

```yaml
# 修改docker-compose.yml中的backend服务
backend:
  environment:
    DB_HOST: 宿主机IP  # 或使用外部MySQL服务
    DB_PORT: 3306
    # 其他配置保持不变
```

#### 3. 端口分配建议

| 服务 | 当前端口 | 建议端口 | 说明 |
|------|----------|----------|------|
| Nginx | 80, 443 | 80, 443 | 标准HTTP/HTTPS端口 |
| 后端API | 8000 | 8000 | 可改为8001, 8002等 |
| 前端 | 3000 | 3000 | 可改为3001, 3002等 |
| MySQL | 内部 | 内部 | 不暴露到主机 |

## 部署步骤

### 1. 服务器准备
```bash
# 安装Docker和Docker Compose
curl -fsSL https://get.docker.com | bash
sudo usermod -aG docker $USER

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 2. 项目部署
```bash
# 克隆项目
git clone <your-repo-url>
cd DCC数字员工/V1.0

# 配置环境变量
cp env.template .env
# 编辑.env文件，填入实际配置

# 启动服务
docker-compose up -d
```

### 3. 验证部署
```bash
# 检查服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 测试API
curl http://your-server-ip/api/health
```

## 多项目共存配置

### 1. 修改端口映射
如果需要在同一服务器部署多个项目，修改`docker-compose.yml`：

```yaml
services:
  backend:
    ports:
      - "8001:8000"  # 改为8001端口
  frontend:
    ports:
      - "3001:3000"  # 改为3001端口
```

### 2. 使用不同域名
在Nginx配置中使用不同域名：

```nginx
# 项目1
server {
    listen 80;
    server_name dcc1.yourdomain.com;
    # DCC项目1配置
}

# 项目2  
server {
    listen 80;
    server_name dcc2.yourdomain.com;
    # DCC项目2配置
}
```

### 3. 数据库隔离
每个项目使用独立的数据库：

```yaml
mysql:
  environment:
    MYSQL_DATABASE: dcc_employee_db_1  # 项目1数据库
    # 或
    MYSQL_DATABASE: dcc_employee_db_2  # 项目2数据库
```

## 监控和维护

### 1. 日志管理
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend

# 清理日志
docker system prune -f
```

### 2. 数据备份
```bash
# 备份MySQL数据
docker exec dcc-mysql mysqldump -u root -p dcc_employee_db > backup.sql

# 恢复数据
docker exec -i dcc-mysql mysql -u root -p dcc_employee_db < backup.sql
```

### 3. 性能监控
```bash
# 查看资源使用情况
docker stats

# 查看容器详细信息
docker inspect dcc-backend
```

## 故障排除

### 1. 端口冲突
```bash
# 检查端口占用
netstat -tulpn | grep :3306
netstat -tulpn | grep :8000

# 停止冲突的服务
sudo systemctl stop mysql  # 如果系统MySQL在运行
```

### 2. 网络问题
```bash
# 检查Docker网络
docker network ls
docker network inspect dcc-network

# 重建网络
docker-compose down
docker network prune
docker-compose up -d
```

### 3. 权限问题
```bash
# 修复文件权限
sudo chown -R $USER:$USER .
chmod +x restart-docker.sh
```

## 安全建议

1. **防火墙配置**：只开放必要端口（80, 443）
2. **SSL证书**：配置HTTPS访问
3. **数据库安全**：使用强密码，限制访问
4. **定期更新**：保持Docker镜像和系统更新
5. **备份策略**：定期备份数据和配置

## 联系支持

如遇到问题，请提供以下信息：
- 服务器系统版本
- Docker版本
- 错误日志
- 部署步骤
