#!/bin/bash

# DCCÊï∞Â≠óÂëòÂ∑•Á≥ªÁªü - Âø´ÈÄüÊï∞ÊçÆÂ∫ì‰øÆÂ§çËÑöÊú¨
# ‰øÆÂ§çÂÖ∑‰ΩìÁöÑÂ≠óÊÆµÂíåË°®ÈóÆÈ¢ò

set -e

echo "üîß DCCÊï∞Â≠óÂëòÂ∑•Á≥ªÁªü - Âø´ÈÄüÊï∞ÊçÆÂ∫ì‰øÆÂ§ç"
echo "================================================"

# È¢úËâ≤ÂÆö‰πâ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Êó•ÂøóÂáΩÊï∞
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ê£ÄÊü•ÁéØÂ¢ÉÂèòÈáè
check_env() {
    log_info "Ê£ÄÊü•ÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆ..."
    if [ ! -f ".env" ]; then
        log_error "Êú™ÊâæÂà∞.envÊñá‰ª∂ÔºåËØ∑ÂÖàÈÖçÁΩÆÁéØÂ¢ÉÂèòÈáè"
        exit 1
    fi
    source .env
    
    if [ -z "$DB_HOST" ] || [ -z "$DB_PORT" ] || [ -z "$DB_USER" ] || [ -z "$DB_PASSWORD" ] || [ -z "$DB_NAME" ]; then
        log_error ".envÊñá‰ª∂‰∏≠Áº∫Â∞ëÊï∞ÊçÆÂ∫ìËøûÊé•‰ø°ÊÅØ"
        exit 1
    fi
    log_success "ÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆÊ£ÄÊü•ÈÄöËøá"
}

# ÊâßË°åSQLÂëΩ‰ª§
execute_sql() {
    local sql="$1"
    local description="$2"
    
    log_info "ÊâßË°å: $description"
    echo "$sql" | mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        log_success "$description ÊâßË°åÂÆåÊàê"
    else
        log_warning "$description ÊâßË°åÂ§±Ë¥•ÔºåÂèØËÉΩÂ≠óÊÆµÂ∑≤Â≠òÂú®"
    fi
}

# ‰øÆÂ§çcall_tasksË°®
fix_call_tasks_table() {
    log_info "‰øÆÂ§çcall_tasksË°®..."
    
    # Ê£ÄÊü•Ë°®ÊòØÂê¶Â≠òÂú®
    local table_exists=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "SHOW TABLES LIKE 'call_tasks';" 2>/dev/null | grep -c "call_tasks" || echo "0")
    
    if [ "$table_exists" -eq 0 ]; then
        log_info "ÂàõÂª∫call_tasksË°®..."
        execute_sql "
            CREATE TABLE call_tasks (
                id INT AUTO_INCREMENT PRIMARY KEY,
                task_name VARCHAR(50) NOT NULL COMMENT '‰ªªÂä°ÂêçÁß∞',
                organization_id VARCHAR(50) NOT NULL COMMENT 'ÁªÑÁªáID',
                create_name_id VARCHAR(50) NOT NULL COMMENT 'ÂàõÂª∫‰∫∫ID',
                create_name VARCHAR(50) NOT NULL COMMENT 'ÂàõÂª∫‰∫∫ÂêçÁß∞',
                create_time DATETIME NOT NULL COMMENT 'ÂàõÂª∫Êó∂Èó¥',
                leads_count INT NOT NULL DEFAULT 0 COMMENT 'Á∫øÁ¥¢Êï∞Èáè',
                script_id VARCHAR(50) DEFAULT NULL COMMENT 'Âú∫ÊôØIDÔºàËÑöÊú¨IDÔºâ',
                task_type INT NOT NULL DEFAULT 1 COMMENT '‰ªªÂä°Á±ªÂûã:1:Â∑≤ÂàõÂª∫Ôºõ2:ÂºÄÂßãÂ§ñÂëºÔºõ3:Â§ñÂëºÂÆåÊàêÔºõ4:Ë∑üËøõÂÆåÊàêÔºõ5:Â∑≤ÊöÇÂÅú;',
                size_desc JSON DEFAULT NULL COMMENT 'Á≠õÈÄâÊù°‰ª∂',
                job_group_id VARCHAR(100) DEFAULT NULL,
                updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                INDEX idx_organization_id (organization_id),
                INDEX idx_task_type (task_type),
                INDEX idx_create_time (create_time)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='Â§ñÂëº‰ªªÂä°Ë°®';
        " "ÂàõÂª∫call_tasksË°®"
    else
        log_info "call_tasksË°®Â∑≤Â≠òÂú®ÔºåÊ£ÄÊü•Â≠óÊÆµ..."
        
        # Ê∑ªÂä†Áº∫Â§±ÁöÑÂ≠óÊÆµ
        execute_sql "ALTER TABLE call_tasks ADD COLUMN IF NOT EXISTS leads_count INT NOT NULL DEFAULT 0 COMMENT 'Á∫øÁ¥¢Êï∞Èáè';" "Ê∑ªÂä†leads_countÂ≠óÊÆµ"
        execute_sql "ALTER TABLE call_tasks ADD COLUMN IF NOT EXISTS size_desc JSON DEFAULT NULL COMMENT 'Á≠õÈÄâÊù°‰ª∂';" "Ê∑ªÂä†size_descÂ≠óÊÆµ"
        execute_sql "ALTER TABLE call_tasks ADD COLUMN IF NOT EXISTS task_type INT NOT NULL DEFAULT 1 COMMENT '‰ªªÂä°Á±ªÂûã:1:Â∑≤ÂàõÂª∫Ôºõ2:ÂºÄÂßãÂ§ñÂëºÔºõ3:Â§ñÂëºÂÆåÊàêÔºõ4:Ë∑üËøõÂÆåÊàêÔºõ5:Â∑≤ÊöÇÂÅú;';" "Ê∑ªÂä†task_typeÂ≠óÊÆµ"
        execute_sql "ALTER TABLE call_tasks ADD COLUMN IF NOT EXISTS organization_id VARCHAR(50) NOT NULL DEFAULT 'DEFAULT_ORG' COMMENT 'ÁªÑÁªáID';" "Ê∑ªÂä†organization_idÂ≠óÊÆµ"
        execute_sql "ALTER TABLE call_tasks ADD COLUMN IF NOT EXISTS create_name_id VARCHAR(50) NOT NULL DEFAULT 'admin' COMMENT 'ÂàõÂª∫‰∫∫ID';" "Ê∑ªÂä†create_name_idÂ≠óÊÆµ"
        execute_sql "ALTER TABLE call_tasks ADD COLUMN IF NOT EXISTS create_name VARCHAR(50) NOT NULL DEFAULT 'admin' COMMENT 'ÂàõÂª∫‰∫∫ÂêçÁß∞';" "Ê∑ªÂä†create_nameÂ≠óÊÆµ"
        execute_sql "ALTER TABLE call_tasks ADD COLUMN IF NOT EXISTS script_id VARCHAR(50) DEFAULT NULL COMMENT 'Âú∫ÊôØIDÔºàËÑöÊú¨IDÔºâ';" "Ê∑ªÂä†script_idÂ≠óÊÆµ"
        execute_sql "ALTER TABLE call_tasks ADD COLUMN IF NOT EXISTS job_group_id VARCHAR(100) DEFAULT NULL;" "Ê∑ªÂä†job_group_idÂ≠óÊÆµ"
        execute_sql "ALTER TABLE call_tasks ADD COLUMN IF NOT EXISTS updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP;" "Ê∑ªÂä†updated_timeÂ≠óÊÆµ"
    fi
}

# ‰øÆÂ§çleads_task_listË°®
fix_leads_task_list_table() {
    log_info "‰øÆÂ§çleads_task_listË°®..."
    
    # Ê£ÄÊü•Ë°®ÊòØÂê¶Â≠òÂú®
    local table_exists=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "SHOW TABLES LIKE 'leads_task_list';" 2>/dev/null | grep -c "leads_task_list" || echo "0")
    
    if [ "$table_exists" -eq 0 ]; then
        log_info "ÂàõÂª∫leads_task_listË°®..."
        execute_sql "
            CREATE TABLE leads_task_list (
                id INT AUTO_INCREMENT PRIMARY KEY,
                task_id INT NOT NULL COMMENT '‰ªªÂä°ID',
                leads_id VARCHAR(50) NOT NULL COMMENT 'Á∫øÁ¥¢ID',
                leads_name VARCHAR(50) NOT NULL COMMENT 'Á∫øÁ¥¢ÂêçÁß∞',
                leads_phone VARCHAR(50) NOT NULL COMMENT 'Á∫øÁ¥¢ÊâãÊú∫Âè∑',
                call_time DATETIME NOT NULL COMMENT '‰ªªÂä°ÂàõÂª∫Êó∂Èó¥',
                call_job_id VARCHAR(100) NOT NULL COMMENT 'ÁîµËØù‰ªªÂä°ID',
                call_conversation JSON DEFAULT NULL COMMENT 'ÈÄöËØùËÆ∞ÂΩïËØ¶ÊÉÖ',
                call_status VARCHAR(100) DEFAULT NULL COMMENT 'ÈÄöËØùÁä∂ÊÄÅ',
                planed_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '‰ªªÂä°ÊâßË°åÊó∂Èó¥',
                updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Êï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥',
                recording_url VARCHAR(500) DEFAULT NULL COMMENT 'ÂΩïÈü≥Êñá‰ª∂URL',
                call_task_id VARCHAR(100) DEFAULT NULL COMMENT 'ÈÄöËØùID',
                calling_number VARCHAR(50) DEFAULT NULL COMMENT '‰∏ªÂè´Âè∑Á†Å',
                leads_follow_id INT DEFAULT NULL COMMENT 'Á∫øÁ¥¢Ë∑üËøõID',
                is_interested INT DEFAULT NULL COMMENT 'ÊòØÂê¶ÊúâÊÑèÂêëÔºåÂ¶ÇÊûúÊó†Ê≥ïÂà§Êñ≠ÔºåÂàôËøîÂõû0ÔºåÊúâÊÑèÂêëËøîÂõû1ÔºõÊó†ÊÑèÂêëËøîÂõû2',
                INDEX idx_task_id (task_id),
                INDEX idx_leads_id (leads_id),
                INDEX idx_call_job_id (call_job_id),
                INDEX idx_leads_follow_id (leads_follow_id)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='Â§ñÂëº‰ªªÂä°ÊòéÁªÜË°®';
        " "ÂàõÂª∫leads_task_listË°®"
    else
        log_success "leads_task_listË°®Â∑≤Â≠òÂú®"
    fi
}

# ‰øÆÂ§çdcc_leads_followË°®
fix_dcc_leads_follow_table() {
    log_info "‰øÆÂ§çdcc_leads_followË°®..."
    
    # Ê£ÄÊü•Ë°®ÊòØÂê¶Â≠òÂú®
    local table_exists=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "SHOW TABLES LIKE 'dcc_leads_follow';" 2>/dev/null | grep -c "dcc_leads_follow" || echo "0")
    
    if [ "$table_exists" -eq 0 ]; then
        log_info "ÂàõÂª∫dcc_leads_followË°®..."
        execute_sql "
            CREATE TABLE dcc_leads_follow (
                id INT AUTO_INCREMENT PRIMARY KEY,
                leads_id INT NOT NULL COMMENT 'Á∫øÁ¥¢ID',
                follow_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Ë∑üËøõÊó∂Èó¥',
                leads_remark VARCHAR(1000) DEFAULT NULL COMMENT 'Ë∑üËøõÂ§áÊ≥®',
                frist_follow_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'È¶ñÊ¨°Ë∑üËøõÊó∂Èó¥',
                new_follow_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ÊúÄÊñ∞Ë∑üËøõÊó∂Èó¥',
                next_follow_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '‰∏ãÊ¨°Ë∑üËøõÊó∂Èó¥',
                is_arrive INT NOT NULL DEFAULT 0 COMMENT 'ÊòØÂê¶Âà∞Â∫ó:0:Âê¶Ôºõ1:ÊòØ',
                frist_arrive_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'È¶ñÊ¨°Âà∞Â∫óÊó∂Èó¥',
                INDEX idx_leads_id (leads_id),
                INDEX idx_follow_time (follow_time),
                INDEX idx_frist_follow_time (frist_follow_time),
                INDEX idx_new_follow_time (new_follow_time),
                INDEX idx_next_follow_time (next_follow_time)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='DCCÁ∫øÁ¥¢Ë∑üËøõË°®';
        " "ÂàõÂª∫dcc_leads_followË°®"
    else
        log_success "dcc_leads_followË°®Â∑≤Â≠òÂú®"
    fi
}

# ‰øÆÂ§çdcc_leadsË°®
fix_dcc_leads_table() {
    log_info "‰øÆÂ§çdcc_leadsË°®..."
    
    # Ê£ÄÊü•Ë°®ÊòØÂê¶Â≠òÂú®
    local table_exists=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "SHOW TABLES LIKE 'dcc_leads';" 2>/dev/null | grep -c "dcc_leads" || echo "0")
    
    if [ "$table_exists" -eq 0 ]; then
        log_info "ÂàõÂª∫dcc_leadsË°®..."
        execute_sql "
            CREATE TABLE dcc_leads (
                id INT AUTO_INCREMENT PRIMARY KEY,
                organization_id VARCHAR(20) NOT NULL COMMENT 'ÁªÑÁªáID',
                leads_id VARCHAR(20) NOT NULL COMMENT 'Á∫øÁ¥¢ID',
                leads_user_name VARCHAR(50) NOT NULL COMMENT 'Á∫øÁ¥¢Áî®Êà∑ÂêçÁß∞',
                leads_user_phone VARCHAR(20) NOT NULL COMMENT 'Á∫øÁ¥¢Áî®Êà∑ÊâãÊú∫Âè∑',
                leads_create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Á∫øÁ¥¢ÂàõÂª∫Êó∂Èó¥',
                leads_product VARCHAR(100) NOT NULL COMMENT 'Á∫øÁ¥¢‰∫ßÂìÅ',
                leads_type VARCHAR(100) NOT NULL COMMENT 'Á∫øÁ¥¢Á≠âÁ∫ß',
                INDEX idx_organization_id (organization_id),
                INDEX idx_leads_id (leads_id),
                INDEX idx_leads_user_phone (leads_user_phone),
                INDEX idx_leads_create_time (leads_create_time)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='DCCÁ∫øÁ¥¢Ë°®';
        " "ÂàõÂª∫dcc_leadsË°®"
    else
        log_success "dcc_leadsË°®Â∑≤Â≠òÂú®"
    fi
}

# È™åËØÅ‰øÆÂ§çÁªìÊûú
verify_fixes() {
    log_info "È™åËØÅ‰øÆÂ§çÁªìÊûú..."
    
    # Ê£ÄÊü•call_tasksË°®ÁöÑÂ≠óÊÆµ
    local leads_count_exists=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "DESCRIBE call_tasks;" 2>/dev/null | grep -c "leads_count" || echo "0")
    local size_desc_exists=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "DESCRIBE call_tasks;" 2>/dev/null | grep -c "size_desc" || echo "0")
    
    if [ "$leads_count_exists" -gt 0 ] && [ "$size_desc_exists" -gt 0 ]; then
        log_success "call_tasksË°®Â≠óÊÆµÈ™åËØÅÈÄöËøá"
    else
        log_error "call_tasksË°®Â≠óÊÆµÈ™åËØÅÂ§±Ë¥•"
        return 1
    fi
    
    # Ê£ÄÊü•dcc_leads_followË°®
    local follow_table_exists=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -e "SHOW TABLES LIKE 'dcc_leads_follow';" 2>/dev/null | grep -c "dcc_leads_follow" || echo "0")
    
    if [ "$follow_table_exists" -gt 0 ]; then
        log_success "dcc_leads_followË°®È™åËØÅÈÄöËøá"
    else
        log_error "dcc_leads_followË°®È™åËØÅÂ§±Ë¥•"
        return 1
    fi
    
    log_success "ÊâÄÊúâ‰øÆÂ§çÈ™åËØÅÈÄöËøá"
}

# ‰∏ªÂáΩÊï∞
main() {
    echo "ÂºÄÂßãÂø´ÈÄüÊï∞ÊçÆÂ∫ì‰øÆÂ§ç..."
    echo ""
    
    check_env
    fix_call_tasks_table
    fix_leads_task_list_table
    fix_dcc_leads_follow_table
    fix_dcc_leads_table
    verify_fixes
    
    log_success "Âø´ÈÄüÊï∞ÊçÆÂ∫ì‰øÆÂ§çÂÆåÊàêÔºÅ"
    echo ""
    log_info "‰øÆÂ§çÂÜÖÂÆπÔºö"
    log_info "1. ‚úÖ ‰øÆÂ§ç‰∫Ücall_tasksË°®ÁöÑleads_countÂíåsize_descÂ≠óÊÆµ"
    log_info "2. ‚úÖ ÂàõÂª∫‰∫Üdcc_leads_followË°®"
    log_info "3. ‚úÖ Á°Æ‰øùleads_task_listË°®Â≠òÂú®"
    log_info "4. ‚úÖ Á°Æ‰øùdcc_leadsË°®Â≠òÂú®"
    log_info ""
    log_info "Áé∞Âú®ÂèØ‰ª•Ê≠£Â∏∏‰ΩøÁî®‰ª•‰∏ãAPIÔºö"
    log_info "- GET /api/tasks (‰ªªÂä°ÂàóË°®)"
    log_info "- GET /api/task-stats (‰ªªÂä°ÁªüËÆ°)"
    log_info "- GET /api/leads/statistics (Á∫øÁ¥¢ÁªüËÆ°)"
}

# ÈîôËØØÂ§ÑÁêÜ
trap 'log_error "Êï∞ÊçÆÂ∫ì‰øÆÂ§çËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºåËØ∑Ê£ÄÊü•Êó•Âøó"; exit 1' ERR

# ÊâßË°å‰∏ªÂáΩÊï∞
main "$@"
